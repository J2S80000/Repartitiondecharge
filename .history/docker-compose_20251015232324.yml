services:
  principal_a:
    image: "mongo"
    container_name: principal_a
    command: --replSet replSet_a --oplogSize 1024 --bind_ip_all
    ports:
      - "27017:27017"
    volumes:
      - ./principal_a/data:/data/db
    networks:
      - mongo-cluster

  secondaire_a_1:
    image: "mongo"
    container_name: secondaire_a_1
    command: --replSet replSet_a --oplogSize 128 --bind_ip_all
    ports:
      - "27018:27017"
    volumes:
      - ./secondaire_a_1/data:/data/db
    networks:
      - mongo-cluster
  
  secondaire_a_2:
    image: "mongo"
    container_name: secondaire_a_2
    command: --replSet replSet_a --oplogSize 128 --bind_ip_all
    ports:
      - "27019:27017"
    volumes:
      - ./secondaire_a_2/data:/data/db
    networks:
      - mongo-cluster

  secondaire_a_3:
    image: "mongo"
    container_name: secondaire_a_3
    command: --replSet replSet_a --oplogSize 128 --bind_ip_all
    ports:
      - "27020:27017"
    volumes:
      - ./secondaire_a_3/data:/data/db
    networks:
      - mongo-cluster
  
  setup-rs:
    image: "mongo"
    container_name: setup-rs
    depends_on:
      - principal_a
      - secondaire_a_1
      - secondaire_a_2
      - secondaire_a_3
    networks:
      - mongo-cluster
    restart: "no"
    entrypoint: >
      bash -c "
      echo 'Attente que principal_a soit prêt...' &&
      until mongosh --host principal_a:27017 --eval 'db.adminCommand({ping:1})' --quiet > /dev/null 2>&1; do
        echo 'En attente de MongoDB principal_a...' &&
        sleep 2
      done &&
      echo 'principal_a est prêt ! Initialisation du replica set...' &&
      mongosh --host principal_a:27017 --eval '
      rs.initiate({
        _id: \"replSet_a\",
        members: [
          { _id: 0, host: \"principal_a:27017\", priority: 2 },
          { _id: 1, host: \"secondaire_a_1:27017\", priority: 1 },
          { _id: 2, host: \"secondaire_a_2:27017\", priority: 1 },
          { _id: 3, host: \"secondaire_a_3:27017\", priority: 1 }
        ]
      })
      ' &&
      echo 'Replica set initialisé avec succès !'
      "

  adminmongo:
    image: "mrvautin/adminmongo"
    container_name: adminmongo
    ports:
      - "1234:1234"
    networks:
      - mongo-cluster

networks:
  mongo-cluster:
    driver: bridge